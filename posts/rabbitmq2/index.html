<!DOCTYPE html>
<html lang='zh' ><meta charset="utf-8">
<meta name="viewport" content="width=device-width">


<title>RabbitMQï¼ˆ2ï¼‰ | DamonZhangğŸ”¥</title>

<meta name="generator" content="Hugo Eureka 0.8.3" />
<link rel="stylesheet" href="https://damon-zhangb.github.io/css/eureka.min.css">
<script defer src="https://damon-zhangb.github.io/js/eureka.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/idea.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js"
   crossorigin></script>

  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js"
     crossorigin></script>

  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/Go.min.js"
     crossorigin></script>

<script defer src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js"
   integrity="sha256-uNYoXefWRqv&#43;PsIF/OflNmwtKM4lStn9yrz2gVl6ymo="  crossorigin></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
   integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" 
  integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
   integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js" 
  integrity="sha256-Zmpaaj&#43;GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE="  crossorigin></script>



<meta name="description"
  content="ä»‹ç»å‘å¸ƒè®¢é˜…ã€è·¯ç”±ã€ä¸»é¢˜äº¤æµåŠåœ¨è¿œå¤„è°ƒç”¨ä¸­çš„è¿ç”¨ã€‚">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Posts",
      "item":"https://damon-zhangb.github.io/posts/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"RabbitMQï¼ˆ2ï¼‰",
      "item":"https://damon-zhangb.github.io/posts/rabbitmq2/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://damon-zhangb.github.io/posts/rabbitmq2/"
    },
    "headline": "RabbitMQï¼ˆ2ï¼‰ | DamonZhangğŸ”¥","wordCount":  1281 ,
    "author": {
        "@type": "Person",
        "name": "Me"
    },
    "publisher": {
        "@type": "Person",
        "name": "Damon",
        },
    "description": "ä»‹ç»å‘å¸ƒè®¢é˜…ã€è·¯ç”±ã€ä¸»é¢˜äº¤æµåŠåœ¨è¿œå¤„è°ƒç”¨ä¸­çš„è¿ç”¨ã€‚"
}
</script><meta property="og:title" content="RabbitMQï¼ˆ2ï¼‰ | DamonZhangğŸ”¥" />
<meta property="og:type" content="article" />



<meta property="og:url" content="https://damon-zhangb.github.io/posts/rabbitmq2/" />



<meta property="og:description" content="ä»‹ç»å‘å¸ƒè®¢é˜…ã€è·¯ç”±ã€ä¸»é¢˜äº¤æµåŠåœ¨è¿œå¤„è°ƒç”¨ä¸­çš„è¿ç”¨ã€‚" />



<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="DamonZhangğŸ”¥" />









<meta property="article:section" content="posts" />


<meta property="article:tag" content="æ¶ˆæ¯é˜Ÿåˆ—" />

<meta property="article:tag" content="åˆ†å¸ƒå¼" />









<meta property="og:see_also" content="https://damon-zhangb.github.io/posts/rabbitmq1/" />







<body class="flex flex-col min-h-screen">
  <header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
    <div class="w-full max-w-screen-xl mx-auto"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="mr-6 text-primary-text text-xl font-bold">DamonZhangğŸ”¥</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">å…³äºæˆ‘</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  mr-4">æ–‡ç« </a>
            <a href="/docs/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">æ¡£æ¡ˆ</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">æµ…è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">æ·±è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">è‡ªåŠ¨</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
  </header>
  <main class="flex-grow pt-16">
    <div class="pl-scrollbar">
      <div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">


<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
        <h1 class="font-bold text-3xl text-primary-text">RabbitMQï¼ˆ2ï¼‰</h1>
        <div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
    <div class="mr-6 my-2">
        <i class="fas fa-calendar mr-1"></i>
        <span>0001-01-01</span>
    </div>
    <div class="mr-6 my-2">
        <i class="fas fa-clock mr-1"></i>
        <span>7åˆ†é’Ÿé˜…è¯»æ—¶é•¿</span>
    </div>
    
    
    <div class="mr-6 my-2">
        <i class="fas fa-folder mr-1"></i>
        
        <a href="https://damon-zhangb.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF/" class="hover:text-eureka">åˆ†å¸ƒå¼æŠ€æœ¯</a>
        
    </div>
    

    
    <div class="mr-6 my-2">
        <i class="fas fa-th-list mr-1"></i>
        
        <a href="https://damon-zhangb.github.io/series/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97rabbitmq/" class="hover:text-eureka">æ¶ˆæ¯é˜Ÿåˆ—RabbitMQ</a>
        
    </div>
    
</div>
        
        
        

        <div class="content">
            <h2 id="å‘å¸ƒè®¢é˜…">å‘å¸ƒ/è®¢é˜…</h2>
<p>åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬æ­å»ºäº†ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œæ¯ä¸ªä»»åŠ¡åªåˆ†å‘ç»™ä¸€ä¸ªå·¥ä½œè€…ï¼ˆworkerï¼‰ã€‚åœ¨æœ¬ç¯‡æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦åšçš„è·Ÿä¹‹å‰å®Œå…¨ä¸ä¸€æ · â€”â€” åˆ†å‘ä¸€ä¸ªæ¶ˆæ¯ç»™å¤šä¸ªæ¶ˆè´¹è€…ï¼ˆconsumersï¼‰ã€‚è¿™ç§æ¨¡å¼è¢«ç§°ä¸º**â€œå‘å¸ƒï¼è®¢é˜…â€ã€‚**</p>
<p>ä¸ºäº†æè¿°è¿™ç§æ¨¡å¼ï¼Œæˆ‘ä»¬å°†ä¼šæ„å»ºä¸€ä¸ªç®€å•çš„æ—¥å¿—ç³»ç»Ÿã€‚å®ƒåŒ…æ‹¬ä¸¤ä¸ªç¨‹åºâ€”â€”ç¬¬ä¸€ä¸ªç¨‹åºè´Ÿè´£å‘é€æ—¥å¿—æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªç¨‹åºè´Ÿè´£è·å–æ¶ˆæ¯å¹¶è¾“å‡ºå†…å®¹ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„è¿™ä¸ªæ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„æ¥æ”¶æ–¹ç¨‹åºéƒ½ä¼šæ¥å—æ¶ˆæ¯ã€‚æˆ‘ä»¬ç”¨å…¶ä¸­ä¸€ä¸ªæ¥æ”¶è€…ï¼ˆreceiverï¼‰æŠŠæ—¥å¿—å†™å…¥ç¡¬ç›˜ä¸­ï¼Œå¦å¤–ä¸€ä¸ªæ¥å—è€…ï¼ˆreceiverï¼‰æŠŠæ—¥å¿—è¾“å‡ºåˆ°å±å¹•ä¸Šã€‚</p>
<p>æœ€ç»ˆï¼Œæ—¥å¿—æ¶ˆæ¯è¢«å¹¿æ’­ç»™æ‰€æœ‰çš„æ¥å—è€…ï¼ˆreceiversï¼‰ã€‚</p>
<h3 id="äº¤æ¢æœºexchanges">äº¤æ¢æœºï¼ˆExchangesï¼‰</h3>
<p>å‰é¢çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—å¹¶ä»ä¸­å–å‡ºæ¶ˆæ¯ã€‚ç°åœ¨æ˜¯æ—¶å€™ä»‹ç»RabbitMQä¸­å®Œæ•´çš„æ¶ˆæ¯æ¨¡å‹äº†ã€‚</p>
<p>è®©æˆ‘ä»¬ç®€å•çš„æ¦‚æ‹¬ä¸€ä¸‹ä¹‹å‰çš„æ•™ç¨‹ï¼š</p>
<ul>
<li>å‘å¸ƒè€…ï¼ˆproducerï¼‰æ˜¯å‘å¸ƒæ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>é˜Ÿåˆ—ï¼ˆqueueï¼‰ç”¨äºæ¶ˆæ¯å­˜å‚¨çš„ç¼“å†²ã€‚</li>
<li>æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰æ˜¯æ¥æ”¶æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚</li>
</ul>
<p><strong>RabbitMQæ¶ˆæ¯æ¨¡å‹çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼šå‘å¸ƒè€…ï¼ˆproducerï¼‰ä¸ä¼šç›´æ¥å‘é€ä»»ä½•æ¶ˆæ¯ç»™é˜Ÿåˆ—</strong>ã€‚äº‹å®ä¸Šï¼Œå‘å¸ƒè€…ï¼ˆproducerï¼‰ç”šè‡³ä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦å·²ç»è¢«æŠ•é€’åˆ°é˜Ÿåˆ—ã€‚</p>
<p><strong>å‘å¸ƒè€…ï¼ˆproducerï¼‰åªéœ€è¦æŠŠæ¶ˆæ¯å‘é€ç»™ä¸€ä¸ªäº¤æ¢æœºï¼ˆexchangeï¼‰</strong>ã€‚äº¤æ¢æœºéå¸¸ç®€å•ï¼Œå®ƒä¸€è¾¹ä»å‘å¸ƒè€…æ–¹æ¥æ”¶æ¶ˆæ¯ï¼Œä¸€è¾¹æŠŠæ¶ˆæ¯æ¨é€åˆ°é˜Ÿåˆ—ã€‚äº¤æ¢æœºå¿…é¡»çŸ¥é“å¦‚ä½•å¤„ç†å®ƒæ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯åº”è¯¥æ¨é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—è¿˜æ˜¯æ˜¯å¤šä¸ªé˜Ÿåˆ—ï¼Œæˆ–è€…æ˜¯ç›´æ¥å¿½ç•¥æ¶ˆæ¯ã€‚è¿™äº›è§„åˆ™æ˜¯é€šè¿‡äº¤æ¢æœºç±»å‹ï¼ˆexchange typeï¼‰æ¥å®šä¹‰çš„ã€‚</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/exchanges.png" alt="exchanges"></p>
<p>æœ‰å‡ ä¸ªå¯ä¾›é€‰æ‹©çš„äº¤æ¢æœºç±»å‹ï¼š<code>direct</code>, <code>topic</code>, <code>headers</code>å’Œ<code>fanout</code>ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œä¸»è¦è¯´æ˜æœ€åä¸€ä¸ª â€”â€” <code>fanout</code>ã€‚å…ˆåˆ›å»ºä¸€ä¸ª<code>fanout</code>ç±»å‹çš„äº¤æ¢æœºï¼Œå‘½åä¸ºlogsï¼š</p>
<pre><code class="language-go">err = ch.ExchangeDeclare(
  &quot;logs&quot;,   // name
  &quot;fanout&quot;, // type
  true,     // durable
  false,    // auto-deleted
  false,    // internal
  false,    // no-wait
  nil,      // arguments
)
</code></pre>
<p><code>fanout</code>äº¤æ¢æœºå¾ˆç®€å•ï¼Œä½ å¯èƒ½ä»åå­—ä¸Šå°±èƒ½çŒœæµ‹å‡ºæ¥ï¼Œå®ƒæŠŠæ¶ˆæ¯å‘é€ç»™å®ƒæ‰€çŸ¥é“çš„æ‰€æœ‰é˜Ÿåˆ—ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿæ‰€éœ€è¦çš„ã€‚</p>
<blockquote>
<h5 id="äº¤æ¢å™¨åˆ—è¡¨">äº¤æ¢å™¨åˆ—è¡¨</h5>
<p><code>rabbitmqctl</code>èƒ½å¤Ÿåˆ—å‡ºæœåŠ¡å™¨ä¸Šæ‰€æœ‰çš„äº¤æ¢å™¨ï¼š<code>sudo rabbitmqctl list_exchanges</code> è¿™ä¸ªåˆ—è¡¨ä¸­æœ‰ä¸€äº›å«åš<code>amq.*</code>çš„åŒ¿åäº¤æ¢å™¨ã€‚è¿™äº›éƒ½æ˜¯é»˜è®¤åˆ›å»ºçš„ï¼Œä¸è¿‡è¿™æ—¶å€™ä½ è¿˜ä¸éœ€è¦ä½¿ç”¨ä»–ä»¬ã€‚</p>
<h5 id="åŒ¿åçš„äº¤æ¢å™¨">åŒ¿åçš„äº¤æ¢å™¨</h5>
<p>å‰é¢çš„æ•™ç¨‹ä¸­æˆ‘ä»¬å¯¹äº¤æ¢æœºä¸€æ— æ‰€çŸ¥ï¼Œä½†ä»ç„¶èƒ½å¤Ÿå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ã€‚å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†å‘½åä¸ºç©ºå­—ç¬¦ä¸²(&quot;&quot;)çš„åŒ¿åäº¤æ¢æœºã€‚ å›æƒ³æˆ‘ä»¬ä¹‹å‰æ˜¯å¦‚ä½•å‘å¸ƒä¸€åˆ™æ¶ˆæ¯ï¼š</p>
<pre><code> err = ch.Publish(
  &quot;&quot;,     // exchange
  q.Name, // routing key
  false,  // mandatory
  false,  // immediate
  amqp.Publishing{
    ContentType: &quot;text/plain&quot;,
    Body:        []byte(body),
})
</code></pre>
<p>exchangeå‚æ•°å°±æ˜¯äº¤æ¢æœºçš„åç§°ã€‚ç©ºå­—ç¬¦ä¸²ä»£è¡¨é»˜è®¤æˆ–è€…åŒ¿åäº¤æ¢æœºï¼Œæ¶ˆæ¯å°†ä¼šæ ¹æ®æŒ‡å®šçš„<code>routing_key</code>åˆ†å‘åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ã€‚</p>
</blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ªå…·åäº¤æ¢æœºäº†ï¼š</p>
<pre><code class="language-go">err = ch.ExchangeDeclare(
  &quot;logs&quot;,   // name
  &quot;fanout&quot;, // type
  true,     // durable
  false,    // auto-deleted
  false,    // internal
  false,    // no-wait
  nil,      // arguments
)
failOnError(err, &quot;Failed to declare an exchange&quot;)

body := bodyFrom(os.Args)
err = ch.Publish(
  &quot;logs&quot;, // exchange
  &quot;&quot;,     // routing key
  false,  // mandatory
  false,  // immediate
  amqp.Publishing{
          ContentType: &quot;text/plain&quot;,
          Body:        []byte(body),
  })
</code></pre>
<h3 id="ä¸´æ—¶é˜Ÿåˆ—">ä¸´æ—¶é˜Ÿåˆ—</h3>
<p>ä½ è¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨çš„é˜Ÿåˆ—åå—ï¼ˆ helloå’Œtask_queueï¼‰ï¼Ÿç»™ä¸€ä¸ªé˜Ÿåˆ—å‘½åæ˜¯å¾ˆé‡è¦çš„â€”â€”æˆ‘ä»¬éœ€è¦æŠŠå·¥ä½œè€…ï¼ˆworkersï¼‰æŒ‡å‘æ­£ç¡®çš„é˜Ÿåˆ—ã€‚å¦‚æœä½ æ‰“ç®—åœ¨å‘å¸ƒè€…ï¼ˆproducersï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆconsumersï¼‰ä¹‹é—´å…±äº«åŒé˜Ÿåˆ—çš„è¯ï¼Œç»™é˜Ÿåˆ—å‘½åæ˜¯ååˆ†é‡è¦çš„ã€‚</p>
<p>ä½†æ˜¯è¿™å¹¶ä¸é€‚ç”¨äºæˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿã€‚æˆ‘ä»¬æ‰“ç®—æ¥æ”¶æ‰€æœ‰çš„æ—¥å¿—æ¶ˆæ¯ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€å°éƒ¨åˆ†ã€‚æˆ‘ä»¬å…³å¿ƒçš„æ˜¯æœ€æ–°çš„æ¶ˆæ¯è€Œä¸æ˜¯æ—§çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹æƒ…ã€‚</p>
<p>é¦–å…ˆï¼Œå½“æˆ‘ä»¬è¿æ¥ä¸ŠRabbitMQçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨æ–°çš„ã€ç©ºçš„é˜Ÿåˆ—ã€‚æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªéšæœºçš„é˜Ÿåˆ—åï¼Œæˆ–è€…è®©æœåŠ¡å™¨ä¸ºæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªéšæœºçš„é˜Ÿåˆ—åï¼ˆæ¨èï¼‰ã€‚</p>
<p>å…¶æ¬¡ï¼Œå½“ä¸æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰æ–­å¼€è¿æ¥çš„æ—¶å€™ï¼Œè¿™ä¸ªé˜Ÿåˆ—åº”å½“è¢«ç«‹å³åˆ é™¤ã€‚ åœ¨<code>amqp</code>å®¢æˆ·ç«¯ä¸­ï¼Œå½“æˆ‘ä»¬å°†é˜Ÿåˆ—åç§°ä½œä¸ºç©ºå­—ç¬¦ä¸²æä¾›æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå…·æœ‰ç”Ÿæˆåç§°çš„éæŒä¹…é˜Ÿåˆ—ï¼š</p>
<pre><code class="language-go">q, err := ch.QueueDeclare(
  &quot;&quot;,    // name
  false, // durable
  false, // delete when usused
  true,  // exclusive
  false, // no-wait
  nil,   // arguments
)
</code></pre>
<p>è¯¥æ–¹æ³•è¿”å›æ—¶ï¼Œé˜Ÿåˆ—å®ä¾‹åŒ…å«RabbitMQç”Ÿæˆçš„éšæœºé˜Ÿåˆ—åç§°ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½çœ‹èµ·æ¥åƒ<code>amq.gen-JzTY20BRgKO-HjmUJj0wLg</code>ã€‚ å½“å£°æ˜å®ƒçš„è¿æ¥å…³é—­æ—¶ï¼Œé˜Ÿåˆ—å°†è¢«åˆ é™¤ï¼Œå› ä¸ºå®ƒè¢«å£°æ˜ä¸º<code>exclusive</code>ã€‚ æ‚¨å¯ä»¥åœ¨<a href="https://www.rabbitmq.com/queues.html">guide on queues</a>äº†è§£æœ‰å…³<code>exclusive</code>å’Œå…¶ä»–é˜Ÿåˆ—å±æ€§çš„æ›´å¤šä¿¡æ¯</p>
<h3 id="ç»‘å®šbindings">ç»‘å®šï¼ˆBindingsï¼‰</h3>
<p><img src="http://www.rabbitmq.com/img/tutorials/bindings.png" alt="bindings"></p>
<p>æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª<code>fanout</code>äº¤æ¢æœºå’Œä¸€ä¸ªé˜Ÿåˆ—ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å‘Šè¯‰äº¤æ¢æœºå¦‚ä½•å‘é€æ¶ˆæ¯ç»™æˆ‘ä»¬çš„é˜Ÿåˆ—ã€‚äº¤æ¢å™¨å’Œé˜Ÿåˆ—ä¹‹é—´çš„è”ç³»æˆ‘ä»¬ç§°ä¹‹ä¸ºç»‘å®šï¼ˆbindingï¼‰ã€‚</p>
<pre><code class="language-go">err = ch.QueueBind(
  q.Name, // queue name
  &quot;&quot;,     // routing key
  &quot;logs&quot;, // exchange
  false,
  nil,
)
</code></pre>
<p>ç°åœ¨ï¼Œlogsäº¤æ¢æœºå°†ä¼šæŠŠæ¶ˆæ¯æ·»åŠ åˆ°æˆ‘ä»¬çš„é˜Ÿåˆ—ä¸­ã€‚</p>
<h3 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h3>
<p>å‘å¸ƒæ—¥å¿—æ¶ˆæ¯çš„ç¨‹åºçœ‹èµ·æ¥å’Œä¹‹å‰çš„æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚æœ€é‡è¦çš„æ”¹å˜å°±æ˜¯æˆ‘ä»¬æŠŠæ¶ˆæ¯å‘é€ç»™logsäº¤æ¢æœºè€Œä¸æ˜¯åŒ¿åäº¤æ¢æœºã€‚åœ¨å‘é€çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æä¾›<code>routing_key</code>å‚æ•°ï¼Œä½†å¯ä»¥å¿½ç•¥å®ƒçš„å€¼ã€‚</p>
<p><em>ä»¥ä¸‹æ˜¯<code>send,go</code>ï¼š</em></p>
<pre><code class="language-go">package main

import (
        &quot;log&quot;
        &quot;os&quot;
        &quot;strings&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        err = ch.ExchangeDeclare(
                &quot;logs&quot;,   // name
                &quot;fanout&quot;, // type
                true,     // durable
                false,    // auto-deleted
                false,    // internal
                false,    // no-wait
                nil,      // arguments
        )
        failOnError(err, &quot;Failed to declare an exchange&quot;)

        body := bodyFrom(os.Args)
        err = ch.Publish(
                &quot;logs&quot;, // exchange
                &quot;&quot;,     // routing key
                false,  // mandatory
                false,  // immediate
                amqp.Publishing{
                        ContentType: &quot;text/plain&quot;,
                        Body:        []byte(body),
                })
        failOnError(err, &quot;Failed to publish a message&quot;)

        log.Printf(&quot; [x] Sent %s&quot;, body)
}

func bodyFrom(args []string) string {
        var s string
        if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
                s = &quot;hello&quot;
        } else {
                s = strings.Join(args[1:], &quot; &quot;)
        }
        return s
}
</code></pre>
<p>æ­£å¦‚ä½ çœ‹åˆ°çš„é‚£æ ·ï¼Œåœ¨è¿æ¥æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªäº¤æ¢å™¨ï¼Œè¿™ä¸€ä¸ªæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºä¸å…è®¸å‘å¸ƒæ¶ˆæ¯åˆ°ä¸å­˜åœ¨çš„äº¤æ¢å™¨ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢å™¨ï¼Œæ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚ä½†è¿™ä¸ªæ²¡æœ‰æ‰€è°“ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç›‘å¬ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¼šè¢«å¿½ç•¥ã€‚</p>
<p><em><code>receive.go</code>:çš„ä»£ç ï¼š</em></p>
<pre><code class="language-go">package main

import (
        &quot;log&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        err = ch.ExchangeDeclare(
                &quot;logs&quot;,   // name
                &quot;fanout&quot;, // type
                true,     // durable
                false,    // auto-deleted
                false,    // internal
                false,    // no-wait
                nil,      // arguments
        )
        failOnError(err, &quot;Failed to declare an exchange&quot;)

        q, err := ch.QueueDeclare(
                &quot;&quot;,    // name
                false, // durable
                false, // delete when usused
                true,  // exclusive
                false, // no-wait
                nil,   // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        err = ch.QueueBind(
                q.Name, // queue name
                &quot;&quot;,     // routing key
                &quot;logs&quot;, // exchange
                false,
                nil,
        )
        failOnError(err, &quot;Failed to bind a queue&quot;)

        msgs, err := ch.Consume(
                q.Name, // queue
                &quot;&quot;,     // consumer
                true,   // auto-ack
                false,  // exclusive
                false,  // no-local
                false,  // no-wait
                nil,    // args
        )
        failOnError(err, &quot;Failed to register a consumer&quot;)

        forever := make(chan bool)

        go func() {
                for d := range msgs {
                        log.Printf(&quot; [x] %s&quot;, d.Body)
                }
        }()

        log.Printf(&quot; [*] Waiting for logs. To exit press CTRL+C&quot;)
        &lt;-forever
}
</code></pre>
<p>è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†ã€‚å¦‚æœä½ æƒ³æŠŠæ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œåªéœ€è¦æ‰“å¼€æ§åˆ¶å°è¾“å…¥ï¼š</p>
<pre><code>$ go run receive.go &gt; logs_from_rabbit.log
</code></pre>
<p>å¦‚æœä½ æƒ³åœ¨å±å¹•ä¸­æŸ¥çœ‹æ—¥å¿—ï¼Œé‚£ä¹ˆæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ç„¶åè¿è¡Œï¼š</p>
<pre><code>$ go run receive.go
</code></pre>
<p>å½“ç„¶è¿˜è¦å‘é€æ—¥å¿—ï¼š</p>
<pre><code>$ go run send.go
</code></pre>
<h2 id="è·¯ç”±">è·¯ç”±</h2>
<p>åœ¨å‰é¢çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—ç³»ç»Ÿã€‚å¯ä»¥æŠŠæ—¥å¿—æ¶ˆæ¯å¹¿æ’­ç»™å¤šä¸ªæ¥æ”¶è€…ã€‚</p>
<p>æœ¬èŠ‚ä¸­æˆ‘ä»¬æ‰“ç®—æ–°å¢ä¸€ä¸ªåŠŸèƒ½ â€”â€” ä½¿å¾—å®ƒèƒ½å¤Ÿåªè®¢é˜…æ¶ˆæ¯çš„ä¸€ä¸ªå­—é›†ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä¸¥é‡çš„é”™è¯¯æ—¥å¿—ä¿¡æ¯å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼ˆå­˜å‚¨åˆ°ç£ç›˜ï¼‰ï¼Œä½†åŒæ—¶ä»ç„¶æŠŠæ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°ä¸­ã€‚</p>
<h3 id="ç»‘å®šbindings-1">ç»‘å®šï¼ˆBindingsï¼‰</h3>
<p><em>å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºè¿‡ç»‘å®šï¼ˆbindingsï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</em></p>
<pre><code class="language-go">err = ch.QueueBind(
  q.Name, // queue name
  &quot;&quot;,     // routing key
  &quot;logs&quot;, // exchange
  false,
  nil)
</code></pre>
<p>ç»‘å®šï¼ˆbindingï¼‰æ˜¯æŒ‡äº¤æ¢æœºï¼ˆexchangeï¼‰å’Œé˜Ÿåˆ—ï¼ˆqueueï¼‰çš„å…³ç³»ã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šè¿™ä¸ªé˜Ÿåˆ—ï¼ˆqueueï¼‰å¯¹è¿™ä¸ªäº¤æ¢æœºï¼ˆexchangeï¼‰çš„æ¶ˆæ¯æ„Ÿå…´è¶£ã€‚</p>
<p>ç»‘å®šçš„æ—¶å€™å¯ä»¥å¸¦ä¸Šä¸€ä¸ªé¢å¤–çš„<code>routing_key</code>å‚æ•°ã€‚ä¸ºäº†é¿å…ä¸<code>Channel.Publish</code>çš„å‚æ•°æ··æ·†ï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšç»‘å®šé”®<code>binding key</code>ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¸¦ç»‘å®šé”®çš„ç»‘å®šã€‚</p>
<pre><code class="language-go">err = ch.QueueBind(
  q.Name,    // queue name
  &quot;black&quot;,   // routing key
  &quot;logs&quot;,    // exchange
  false,
  nil)
</code></pre>
<p>ç»‘å®šé”®çš„æ„ä¹‰å–å†³äºäº¤æ¢æœºï¼ˆexchangeï¼‰çš„ç±»å‹ã€‚æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨è¿‡<code>fanout</code> äº¤æ¢æœºä¼šå¿½ç•¥è¿™ä¸ªå€¼ã€‚</p>
<h3 id="ç›´è¿äº¤æ¢æœºdirect-exchange">ç›´è¿äº¤æ¢æœºï¼ˆDirect exchangeï¼‰</h3>
<p>æˆ‘ä»¬çš„æ—¥å¿—ç³»ç»Ÿå¹¿æ’­æ‰€æœ‰çš„æ¶ˆæ¯ç»™æ‰€æœ‰çš„æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰ã€‚æˆ‘ä»¬æ‰“ç®—æ‰©å±•å®ƒï¼Œä½¿å…¶åŸºäºæ—¥å¿—çš„ä¸¥é‡ç¨‹åº¦è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¹Ÿè®¸åªæ˜¯å¸Œæœ›å°†æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯ï¼ˆerrorï¼‰æ—¥å¿—å†™å…¥ç£ç›˜ï¼Œä»¥å…åœ¨è­¦å‘Šï¼ˆwarningï¼‰æˆ–è€…ä¿¡æ¯ï¼ˆinfoï¼‰æ—¥å¿—ä¸Šæµªè´¹ç£ç›˜ç©ºé—´ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨çš„<code>fanout</code> äº¤æ¢æœºæ²¡æœ‰è¶³å¤Ÿçš„çµæ´»æ€§ â€”â€” å®ƒèƒ½åšçš„ä»…ä»…æ˜¯å¹¿æ’­ã€‚</p>
<p>æˆ‘ä»¬å°†ä¼šä½¿ç”¨<code>direct</code> äº¤æ¢æœºæ¥ä»£æ›¿ã€‚è·¯ç”±çš„ç®—æ³•å¾ˆç®€å• â€”â€” äº¤æ¢æœºå°†ä¼šå¯¹<code>binding key</code>å’Œ<code>routing key</code>è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œä»è€Œç¡®å®šæ¶ˆæ¯è¯¥åˆ†å‘åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</p>
<p>ä¸‹å›¾èƒ½å¤Ÿå¾ˆå¥½çš„æè¿°è¿™ä¸ªåœºæ™¯ï¼š</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/direct-exchange.png" alt="direct-exchange"></p>
<p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>direct</code>äº¤æ¢æœº Xå’Œä¸¤ä¸ªé˜Ÿåˆ—è¿›è¡Œäº†ç»‘å®šã€‚ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ä½¿ç”¨<code>orange</code>ä½œä¸ºbinding keyï¼Œç¬¬äºŒä¸ªé˜Ÿåˆ—æœ‰ä¸¤ä¸ªç»‘å®šï¼Œä¸€ä¸ªä½¿ç”¨<code>black</code>ä½œä¸ºbinding keyï¼Œå¦å¤–ä¸€ä¸ªä½¿ç”¨<code>green</code>ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œå½“æ¶ˆæ¯å‘å¸ƒåˆ°routing keyä¸º<code>orange</code>çš„äº¤æ¢æœºæ—¶ï¼Œå°±ä¼šè¢«è·¯ç”±åˆ°é˜Ÿåˆ—Q1ã€‚routing keyä¸º<code>black</code>æˆ–è€…<code>green</code>çš„æ¶ˆæ¯å°±ä¼šè·¯ç”±åˆ°Q2ã€‚å…¶ä»–çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å°†ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<h3 id="å¤šä¸ªç»‘å®šmultiple-bindings">å¤šä¸ªç»‘å®šï¼ˆMultiple bindingsï¼‰</h3>
<p><img src="http://www.rabbitmq.com/img/tutorials/direct-exchange-multiple.png" alt="direct-exchange-multiple"></p>
<p>å¤šä¸ªé˜Ÿåˆ—ä½¿ç”¨ç›¸åŒçš„binding keyæ˜¯åˆæ³•çš„ã€‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªXå’ŒQ1ä¹‹é—´çš„ç»‘å®šï¼Œä½¿ç”¨<code>black</code>ä¸ºbinding keyã€‚è¿™æ ·ä¸€æ¥ï¼Œ<code>direct</code>äº¤æ¢æœºå°±å’Œ<code>fanout</code>äº¤æ¢æœºçš„è¡Œä¸ºä¸€æ ·ï¼Œä¼šå°†æ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ã€‚å¸¦æœ‰routing keyä¸º<code>black</code>çš„æ¶ˆæ¯ä¼šåŒæ—¶å‘é€åˆ°Q1å’ŒQ2ã€‚</p>
<h3 id="å‘é€æ—¥å¿—">å‘é€æ—¥å¿—</h3>
<p>æˆ‘ä»¬å°†ä¼šå‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ª<code>direct</code>ï¼ŒæŠŠæ—¥å¿—ç­‰çº§ä½œä¸º<code>routing key</code>ã€‚è¿™æ ·æ¥æ”¶æ—¥å¿—å°±å¯ä»¥æ ¹æ®æ—¥å¿—çº§åˆ«æ¥é€‰æ‹©å®ƒæƒ³è¦å¤„ç†çš„æ—¥å¿—ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹å‘é€æ—¥å¿—ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªäº¤æ¢æœºï¼ˆexchangeï¼‰ï¼š</p>
<pre><code class="language-go">err = ch.ExchangeDeclare(
  &quot;logs_direct&quot;, // name
  &quot;direct&quot;,      // type
  true,          // durable
  false,         // auto-deleted
  false,         // internal
  false,         // no-wait
  nil,           // arguments
)
</code></pre>
<p>ç„¶åæˆ‘ä»¬å‘é€ä¸€åˆ™æ¶ˆæ¯ï¼š</p>
<pre><code class="language-go">body := bodyFrom(os.Args)
err = ch.Publish(
  &quot;logs_direct&quot;,         // exchange
  severityFrom(os.Args), // routing key
  false, // mandatory
  false, // immediate
  amqp.Publishing{
    ContentType: &quot;text/plain&quot;,
    Body:        []byte(body),
})
</code></pre>
<p>severityFromå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">func severityFrom(args []string) string {
        var s string
        if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
                s = &quot;info&quot;
        } else {
                s = os.Args[1]
        }
        return s
}
</code></pre>
<p>æˆ‘ä»¬å‡è®¾æ—¥å¿—ç­‰çº§çš„å€¼æ˜¯infoã€warningã€errorä¸­çš„ä¸€ä¸ªã€‚</p>
<h3 id="è®¢é˜…">è®¢é˜…</h3>
<p>å¤„ç†æ¥æ”¶æ¶ˆæ¯çš„æ–¹å¼å’Œä¹‹å‰å·®ä¸å¤šï¼Œåªæœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œæˆ‘ä»¬å°†ä¼šä¸ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„æ¯ä¸ªä¸¥é‡çº§åˆ«åˆ†åˆ«åˆ›å»ºä¸€ä¸ªæ–°çš„ç»‘å®šã€‚</p>
<pre><code class="language-go">q, err := ch.QueueDeclare(
  &quot;&quot;,    // name
  false, // durable
  false, // delete when usused
  true,  // exclusive
  false, // no-wait
  nil,   // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)

if len(os.Args) &lt; 2 {
  log.Printf(&quot;Usage: %s [info] [warning] [error]&quot;, os.Args[0])
  os.Exit(0)
}
for _, s := range os.Args[1:] {
  log.Printf(&quot;Binding queue %s to exchange %s with routing key %s&quot;,
     q.Name, &quot;logs_direct&quot;, s)
  err = ch.QueueBind(
    q.Name,        // queue name
    s,             // routing key
    &quot;logs_direct&quot;, // exchange
    false,
    nil)
  failOnError(err, &quot;Failed to bind a queue&quot;)
}
</code></pre>
<h3 id="å®Œæ•´ä»£ç -1">å®Œæ•´ä»£ç ï¼š</h3>
<p><img src="http://www.rabbitmq.com/img/tutorials/python-four.png" alt="python-four"></p>
<p><code>send.go</code>ä»£ç :</p>
<pre><code class="language-go">package main

import (
        &quot;log&quot;
        &quot;os&quot;
        &quot;strings&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        err = ch.ExchangeDeclare(
                &quot;logs_direct&quot;, // name
                &quot;direct&quot;,      // type
                true,          // durable
                false,         // auto-deleted
                false,         // internal
                false,         // no-wait
                nil,           // arguments
        )
        failOnError(err, &quot;Failed to declare an exchange&quot;)

        body := bodyFrom(os.Args)
        err = ch.Publish(
                &quot;logs_direct&quot;,         // exchange
                severityFrom(os.Args), // routing key
                false, // mandatory
                false, // immediate
                amqp.Publishing{
                        ContentType: &quot;text/plain&quot;,
                        Body:        []byte(body),
                })
        failOnError(err, &quot;Failed to publish a message&quot;)

        log.Printf(&quot; [x] Sent %s&quot;, body)
}

func bodyFrom(args []string) string {
        var s string
        if (len(args) &lt; 3) || os.Args[2] == &quot;&quot; {
                s = &quot;hello&quot;
        } else {
                s = strings.Join(args[2:], &quot; &quot;)
        }
        return s
}

func severityFrom(args []string) string {
        var s string
        if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
                s = &quot;info&quot;
        } else {
                s = os.Args[1]
        }
        return s
}
</code></pre>
<p><code>receive.go</code>ä»£ç ï¼š</p>
<pre><code class="language-go">package main

import (
        &quot;log&quot;
        &quot;os&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        err = ch.ExchangeDeclare(
                &quot;logs_direct&quot;, // name
                &quot;direct&quot;,      // type
                true,          // durable
                false,         // auto-deleted
                false,         // internal
                false,         // no-wait
                nil,           // arguments
        )
        failOnError(err, &quot;Failed to declare an exchange&quot;)

        q, err := ch.QueueDeclare(
                &quot;&quot;,    // name
                false, // durable
                false, // delete when usused
                true,  // exclusive
                false, // no-wait
                nil,   // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        if len(os.Args) &lt; 2 {
                log.Printf(&quot;Usage: %s [info] [warning] [error]&quot;, os.Args[0])
                os.Exit(0)
        }
        for _, s := range os.Args[1:] {
                log.Printf(&quot;Binding queue %s to exchange %s with routing key %s&quot;,
                        q.Name, &quot;logs_direct&quot;, s)
                err = ch.QueueBind(
                        q.Name,        // queue name
                        s,             // routing key
                        &quot;logs_direct&quot;, // exchange
                        false,
                        nil)
                failOnError(err, &quot;Failed to bind a queue&quot;)
        }

        msgs, err := ch.Consume(
                q.Name, // queue
                &quot;&quot;,     // consumer
                true,   // auto ack
                false,  // exclusive
                false,  // no local
                false,  // no wait
                nil,    // args
        )
        failOnError(err, &quot;Failed to register a consumer&quot;)

        forever := make(chan bool)

        go func() {
                for d := range msgs {
                        log.Printf(&quot; [x] %s&quot;, d.Body)
                }
        }()

        log.Printf(&quot; [*] Waiting for logs. To exit press CTRL+C&quot;)
        &lt;-forever
}
</code></pre>
<p>å¦‚æœä½ å¸Œæœ›åªæ˜¯ä¿å­˜warningå’Œerrorçº§åˆ«çš„æ—¥å¿—åˆ°ç£ç›˜ï¼Œåªéœ€è¦æ‰“å¼€æ§åˆ¶å°å¹¶è¾“å…¥ï¼š</p>
<pre><code>$ go run receive.go warning error &gt; logs_from_rabbit.log
</code></pre>
<p>å¦‚æœä½ å¸Œæœ›æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯éƒ½è¾“å‡ºåˆ°å±å¹•ä¸­ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œç„¶åè¾“å…¥ï¼š</p>
<pre><code>go run receive.go info warning error
# =&gt; [*] Waiting for logs. To exit press CTRL+C
</code></pre>
<p>å¦‚æœè¦è§¦å‘ä¸€ä¸ªerrorçº§åˆ«çš„æ—¥å¿—ï¼Œåªéœ€è¦è¾“å…¥ï¼š</p>
<pre><code>go run send.go error &quot;Run. Run. Or it will explode.&quot;
# =&gt; [x] Sent 'error':'Run. Run. Or it will explode.'
</code></pre>

        </div>
        
        <div class="my-4">
    
    <a href="https://damon-zhangb.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#æ¶ˆæ¯é˜Ÿåˆ—</a>
    
    <a href="https://damon-zhangb.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#åˆ†å¸ƒå¼</a>
    
</div>
        
        
        


        
        
        <div class="py-2">
    
    <div class="flex flex-col md:flex-row items-center my-8">
        <a href="https://damon-zhangb.github.io/authors/me/" class="w-24 h-24 md:mr-4">
            
            
            <img src="https://damon-zhangb.github.io/android-chrome-512x512.png" class="w-full bg-primary-bg rounded-full" alt="Avatar">
            
        </a>
        <div class="w-full md:w-auto mt-4 md:mt-0">
            <a href="https://damon-zhangb.github.io/authors/me/" class="block font-bold text-lg pb-1 mb-2 border-b">Zhang Bu</a>
            <span class="block pb-2">Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos.</span>
            
            
            
            
            
            <a href="mailto:example@example.com" class="mr-1">
                <i class="fab fa-fab fa-weixin"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-fab fa-qq"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-github"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-fab fa-zhihu"></i>
            </a>
            
        </div>
    </div>
    
</div>
        
        
        
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
    <div>
        
        <span class="block font-bold">ä¸Šä¸€é¡µ</span>
        <a href="https://damon-zhangb.github.io/posts/rpc-%E5%85%A5%E9%97%A8/" class="block">RPC --å…¥é—¨</a>
        
    </div>
    <div class="md:text-right mt-4 md:mt-0">
        
    </div>
</div>

        



    </div>
    
    <div class="col-span-2">
        
        
<div class="bg-secondary-bg rounded p-6">
    <h3 class="text-lg font-semibold mb-4">ç³»åˆ—æ–‡ç« </h3>
    <div class="content">
        
        
        <a href="https://damon-zhangb.github.io/posts/rabbitmq1/">RabbitMQï¼ˆ1ï¼‰</a>
        <br />
        
        <a href="https://damon-zhangb.github.io/posts/rabbitmq2/">RabbitMQï¼ˆ2ï¼‰</a>
        <br />
        
        
    </div>
</div>
        
        
        <div class="sticky top-16 z-10 hidden lg:block px-6 py-4  bg-primary-bg ">
    <span class="text-lg font-semibold">æœ¬é¡µå†…å®¹</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6 ">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#å‘å¸ƒè®¢é˜…">å‘å¸ƒ/è®¢é˜…</a>
      <ul>
        <li><a href="#äº¤æ¢æœºexchanges">äº¤æ¢æœºï¼ˆExchangesï¼‰</a>
          <ul>
            <li>
              <ul>
                <li><a href="#äº¤æ¢å™¨åˆ—è¡¨">äº¤æ¢å™¨åˆ—è¡¨</a></li>
                <li><a href="#åŒ¿åçš„äº¤æ¢å™¨">åŒ¿åçš„äº¤æ¢å™¨</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#ä¸´æ—¶é˜Ÿåˆ—">ä¸´æ—¶é˜Ÿåˆ—</a></li>
        <li><a href="#ç»‘å®šbindings">ç»‘å®šï¼ˆBindingsï¼‰</a></li>
        <li><a href="#å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </a></li>
      </ul>
    </li>
    <li><a href="#è·¯ç”±">è·¯ç”±</a>
      <ul>
        <li><a href="#ç»‘å®šbindings-1">ç»‘å®šï¼ˆBindingsï¼‰</a></li>
        <li><a href="#ç›´è¿äº¤æ¢æœºdirect-exchange">ç›´è¿äº¤æ¢æœºï¼ˆDirect exchangeï¼‰</a></li>
        <li><a href="#å¤šä¸ªç»‘å®šmultiple-bindings">å¤šä¸ªç»‘å®šï¼ˆMultiple bindingsï¼‰</a></li>
        <li><a href="#å‘é€æ—¥å¿—">å‘é€æ—¥å¿—</a></li>
        <li><a href="#è®¢é˜…">è®¢é˜…</a></li>
        <li><a href="#å®Œæ•´ä»£ç -1">å®Œæ•´ä»£ç ï¼š</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        enableStickyToc();
    });
</script>
        
    </div>
    

    
    
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded p-6">
        <h2 class="text-lg font-semibold mb-4">ç›¸å…³</h2>
        <div class="content">
            
            <a href="https://damon-zhangb.github.io/posts/rabbitmq1/">RabbitMQï¼ˆ1ï¼‰</a>
            <br />
            
            <a href="https://damon-zhangb.github.io/posts/rpc-protobuf/">RPC --ProtoBuf</a>
            <br />
            
            <a href="https://damon-zhangb.github.io/posts/rpc-%E5%85%A5%E9%97%A8/">RPC --å…¥é—¨</a>
            <br />
            
        </div>
    </div>
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        hljs.initHighlightingOnLoad();
    })
</script>

      </div>
    </div>
    
  </main>
  <footer class="pl-scrollbar">
    <div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text">&copy; 2021 <a href="https://github.com/Damon-Zhangb">Damon.Zhang</a>
 &middot;  Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
  </footer>
</body>

</html>