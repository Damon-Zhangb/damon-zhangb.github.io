<!DOCTYPE html>
<html lang='zh' ><meta charset="utf-8">
<meta name="viewport" content="width=device-width">


<title>RabbitMQï¼ˆ1ï¼‰ | DamonZhangğŸ”¥</title>

<meta name="generator" content="Hugo Eureka 0.8.3" />
<link rel="stylesheet" href="https://damon-zhangb.github.io/css/eureka.min.css">
<script defer src="https://damon-zhangb.github.io/js/eureka.min.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/idea.min.css"
   media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js"
   crossorigin></script>

  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js"
     crossorigin></script>

  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/Go.min.js"
     crossorigin></script>

<script defer src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js"
   integrity="sha256-uNYoXefWRqv&#43;PsIF/OflNmwtKM4lStn9yrz2gVl6ymo="  crossorigin></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
   integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X"  media="print"
  onload="this.media='all';this.onload=null" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" 
  integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4"  crossorigin></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
   integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"  crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true }
      ],
    });
  });
</script>


<script defer src="https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js" 
  integrity="sha256-Zmpaaj&#43;GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE="  crossorigin></script>



<meta name="description"
  content="RabbitMQæ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ã€‚">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
      "@type": "ListItem",
      "position": 1 ,
      "name":"Posts",
      "item":"https://damon-zhangb.github.io/posts/"},{
      "@type": "ListItem",
      "position": 2 ,
      "name":"RabbitMQï¼ˆ1ï¼‰",
      "item":"https://damon-zhangb.github.io/posts/rabbitmq/"}]
}
</script>



<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://damon-zhangb.github.io/posts/rabbitmq/"
    },
    "headline": "RabbitMQï¼ˆ1ï¼‰ | DamonZhangğŸ”¥","datePublished": "2021-11-08T09:30:18+08:00",
    "dateModified": "2021-11-08T09:30:18+08:00",
    "wordCount":  1429 ,
    "author": {
        "@type": "Person",
        "name": "Me"
    },
    "publisher": {
        "@type": "Person",
        "name": "Damon",
        },
    "description": "RabbitMQæ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ã€‚"
}
</script><meta property="og:title" content="RabbitMQï¼ˆ1ï¼‰ | DamonZhangğŸ”¥" />
<meta property="og:type" content="article" />



<meta property="og:url" content="https://damon-zhangb.github.io/posts/rabbitmq/" />



<meta property="og:description" content="RabbitMQæ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼‰ã€‚" />



<meta property="og:locale" content="zh" />




<meta property="og:site_name" content="DamonZhangğŸ”¥" />






<meta property="article:published_time" content="2021-11-08T09:30:18&#43;08:00" />


<meta property="article:modified_time" content="2021-11-08T09:30:18&#43;08:00" />



<meta property="article:section" content="posts" />


<meta property="article:tag" content="æ¶ˆæ¯é˜Ÿåˆ—" />

<meta property="article:tag" content="åˆ†å¸ƒå¼" />













<body class="flex flex-col min-h-screen">
  <header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
    <div class="w-full max-w-screen-xl mx-auto"><script>
    let storageColorScheme = localStorage.getItem("lightDarkMode")
    if (((storageColorScheme == 'Auto' || storageColorScheme == null) && window.matchMedia("(prefers-color-scheme: dark)").matches) || storageColorScheme == "Dark") {
        document.getElementsByTagName('html')[0].classList.add('dark')
    }
</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
    <a href="/" class="mr-6 text-primary-text text-xl font-bold">DamonZhangğŸ”¥</a>
    <button id="navbar-btn" class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="target"
        class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
        <div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
            <a href="/#about" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">å…³äºæˆ‘</a>
            <a href="/posts/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  selected-menu-item  mr-4">æ–‡ç« </a>
            <a href="/docs/" class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2  border-transparent  mr-4">æ¡£æ¡ˆ</a>
        </div>

        <div class="flex">
            <div class="relative pt-4 md:pt-0">
                <div class="cursor-pointer hover:text-eureka" id="lightDarkMode">
                    <i class="fas fa-adjust"></i>
                </div>
                <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id="is-open">
                </div>
                <div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40"
                    id='lightDarkOptions'>
                    <span class="px-4 py-1 hover:text-eureka" name="Light">æµ…è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Dark">æ·±è‰²</span>
                    <span class="px-4 py-1 hover:text-eureka" name="Auto">è‡ªåŠ¨</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id="is-open-mobile">
    </div>

</nav>
<script>
    
    let element = document.getElementById('lightDarkMode')
    if (storageColorScheme == null || storageColorScheme == 'Auto') {
        document.addEventListener('DOMContentLoaded', () => {
            window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change', switchDarkMode)
        })
    } else if (storageColorScheme == "Light") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'sun')
        element.firstElementChild.classList.add('fa-sun')
    } else if (storageColorScheme == "Dark") {
        element.firstElementChild.classList.remove('fa-adjust')
        element.firstElementChild.setAttribute("data-icon", 'moon')
        element.firstElementChild.classList.add('fa-moon')
    }

    document.addEventListener('DOMContentLoaded', () => {
        getcolorscheme();
        switchBurger();
    });
</script>
</div>
  </header>
  <main class="flex-grow pt-16">
    <div class="pl-scrollbar">
      <div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">


<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
        <h1 class="font-bold text-3xl text-primary-text">RabbitMQï¼ˆ1ï¼‰</h1>
        <div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
    <div class="mr-6 my-2">
        <i class="fas fa-calendar mr-1"></i>
        <span>2021-11-08</span>
    </div>
    <div class="mr-6 my-2">
        <i class="fas fa-clock mr-1"></i>
        <span>7åˆ†é’Ÿé˜…è¯»æ—¶é•¿</span>
    </div>
    
    
    <div class="mr-6 my-2">
        <i class="fas fa-folder mr-1"></i>
        
        <a href="https://damon-zhangb.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF/" class="hover:text-eureka">åˆ†å¸ƒå¼æŠ€æœ¯</a>
        
    </div>
    

    
    <div class="mr-6 my-2">
        <i class="fas fa-th-list mr-1"></i>
        
        <a href="https://damon-zhangb.github.io/series/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97rabbitmq/" class="hover:text-eureka">æ¶ˆæ¯é˜Ÿåˆ—RabbitMQ</a>
        
    </div>
    
</div>
        
        
        

        <div class="content">
            <h1 id="rabbitmq1">rabbitmqï¼ˆ1ï¼‰</h1>
<h2 id="hello-world">hello world</h2>
<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p><strong>RabbitMQ</strong> æ˜¯ä¸€ä¸ª<strong>æ¶ˆæ¯ä»£ç†</strong>ï¼šå®ƒæ¥å—å’Œè½¬å‘æ¶ˆæ¯ã€‚ä½ å¯ä»¥å°†å…¶è§†ä¸ºé‚®å±€ï¼šå½“ä½ å°†è¦æŠ•é€’çš„é‚®ä»¶æ”¾å…¥é‚®ç®±æ—¶ï¼Œä½ å¯ä»¥ç¡®å®šä¿¡ä»¶æ‰¿è¿äººæœ€ç»ˆä¼šå°†é‚®ä»¶é€’é€ç»™æ‚¨çš„æ”¶ä»¶äººã€‚åœ¨è¿™ä¸ªæ¯”å–»ä¸­ï¼ŒRabbitMQ æ˜¯ä¸€ä¸ªé‚®ç®±ã€ä¸€ä¸ªé‚®å±€å’Œä¸€ä¸ªä¿¡ä»¶è½½ä½“ã€‚</p>
<p><strong>RabbitMQ</strong> å’Œé‚®å±€ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä¸å¤„ç†ä¿¡ä»¶å†…å®¹ï¼Œè€Œæ˜¯æ¥å—ã€å­˜å‚¨å’Œè½¬å‘äºŒè¿›åˆ¶æ•°æ® blob<em>æ¶ˆæ¯</em>ã€‚</p>
<p><strong>RabbitMQ</strong> å’Œä¸€èˆ¬çš„æ¶ˆæ¯ä¼ é€’ä½¿ç”¨äº†ä¸€äº›è¡Œè¯ï¼š</p>
<ul>
<li>
<p><em>ç”Ÿäº§</em>æ— éå°±æ˜¯å‘é€ã€‚å‘é€æ¶ˆæ¯çš„ç¨‹åºæ˜¯<em>ç”Ÿäº§è€…</em>ï¼š</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/producer.png" alt="producer"></p>
</li>
<li>
<p><em>é˜Ÿåˆ—</em>æ˜¯ä½äº <strong>RabbitMQ</strong> ä¸­çš„é‚®ç®±çš„åç§°ã€‚å°½ç®¡æ¶ˆæ¯æµç» <strong>RabbitMQ</strong> å’Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä½†å®ƒä»¬åªèƒ½å­˜å‚¨åœ¨<em>é˜Ÿåˆ—ä¸­</em>ã€‚ç”²<em>é˜Ÿåˆ—</em>ä»…ç”±ä¸»æœºçš„å­˜å‚¨å™¨ï¼†ç£ç›˜é™åˆ¶çº¦æŸï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤§çš„<strong>æ¶ˆæ¯ç¼“å†²å™¨</strong>ã€‚è®¸å¤š<em>ç”Ÿäº§è€…</em>å¯ä»¥å°†æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè®¸å¤š<em>æ¶ˆè´¹è€…</em>å¯ä»¥å°è¯•ä»ä¸€ä¸ª<em>é˜Ÿåˆ—</em>æ¥æ”¶æ•°æ®ã€‚è¿™æ˜¯æˆ‘ä»¬è¡¨ç¤ºé˜Ÿåˆ—çš„æ–¹å¼ï¼š</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/queue.png" alt="queue"></p>
</li>
<li>
<p><em>æ¶ˆè´¹</em>ä¸æ¥æ”¶å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰ã€‚ä¸€ä¸ª<em>æ¶ˆè´¹è€…</em>æ˜¯ä¸€ä¸ªç¨‹åºï¼Œä¸»è¦æ˜¯ç­‰å¾…æ¥æ”¶ä¿¡æ¯ï¼š</p>
</li>
</ul>
<p><img src="https://www.rabbitmq.com/img/tutorials/consumer.png" alt="consumer"></p>
<p><em>è¯·æ³¨æ„</em>ï¼Œç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å’Œä»£ç†ä¸å¿…é©»ç•™åœ¨åŒä¸€ä¸»æœºä¸Šï¼›å®é™…ä¸Šï¼Œåœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­å®ƒä»¬æ²¡æœ‰ã€‚åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥æ—¢æ˜¯ç”Ÿäº§è€…åˆæ˜¯æ¶ˆè´¹è€…ã€‚</p>
<h3 id="hello-world-1">Hello World</h3>
<p>åœ¨è¿™ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç”¨ Go ç¼–å†™ä¸¤ä¸ªå°ç¨‹åºï¼›<strong>å‘é€å•ä¸ªæ¶ˆæ¯çš„ç”Ÿäº§è€…</strong>å’Œæ¥<strong>æ”¶æ¶ˆæ¯å¹¶å°†å…¶æ‰“å°å‡ºæ¥çš„æ¶ˆè´¹è€…</strong>ã€‚</p>
<p>åœ¨ä¸‹å›¾ä¸­ï¼Œâ€œPâ€æ˜¯æˆ‘ä»¬çš„ç”Ÿäº§è€…ï¼Œâ€œCâ€æ˜¯æˆ‘ä»¬çš„æ¶ˆè´¹è€…ã€‚ä¸­é—´çš„ç›’å­æ˜¯ä¸€ä¸ªé˜Ÿåˆ—â€”â€”<strong>RabbitMQ</strong> ä»£è¡¨æ¶ˆè´¹è€…ä¿ç•™çš„æ¶ˆæ¯ç¼“å†²åŒºã€‚</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/python-one.png" alt="python-one"></p>
<blockquote>
<h5 id="go-rabbitmq-å®¢æˆ·ç«¯åº“">Go RabbitMQ å®¢æˆ·ç«¯åº“</h5>
<p>RabbitMQ ä½¿ç”¨å¤šç§åè®®ã€‚æœ¬æ•™ç¨‹ä½¿ç”¨ AMQP 0-9-1ï¼Œè¿™æ˜¯ä¸€ç§ç”¨äºæ¶ˆæ¯ä¼ é€’çš„å¼€æ”¾å¼é€šç”¨åè®®ã€‚RabbitMQ æœ‰è®¸å¤šä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨ Go amqp å®¢æˆ·ç«¯ã€‚</p>
<p>é¦–å…ˆï¼Œä½¿ç”¨go getå®‰è£… amqp ï¼š</p>
<pre><code class="language-sh">go get github.com/streadway/amqp
</code></pre>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®‰è£…äº† amqpï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€äº›ä»£ç ã€‚</p>
<h4 id="å‘é€">å‘é€</h4>
<p><img src="https://www.rabbitmq.com/img/tutorials/sending.png" alt="sending"></p>
<p>æˆ‘ä»¬å°†è°ƒç”¨æˆ‘ä»¬çš„æ¶ˆæ¯å‘å¸ƒè€…ï¼ˆå‘é€è€…ï¼‰<code>send.go</code>å’Œæˆ‘ä»¬çš„æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆæ¥æ”¶è€…ï¼‰ <code>receive.go</code>ã€‚å‘å¸ƒè€…å°†è¿æ¥åˆ° <strong>RabbitMQ</strong>ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åé€€å‡ºã€‚</p>
<p><em>åœ¨ <code>send.go</code> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¼å…¥åº“</em>:</p>
<pre><code class="language-go">package main

import (
  &quot;log&quot;
  &quot;github.com/streadway/amqp&quot;
)
</code></pre>
<p><em>æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æ£€æŸ¥æ¯ä¸ª amqp è°ƒç”¨çš„è¿”å›å€¼ï¼š</em></p>
<pre><code class="language-go">func  failOnError (err error, msg string ) {
   if err != nil {
    log.Fatalf( &quot;%s: %s&quot; , msg, err)
  }
}
</code></pre>
<p><em>ç„¶åè¿æ¥åˆ°RabbitMQæœåŠ¡å™¨</em></p>
<pre><code class="language-go">conn, err := amqp.Dial( &quot;amqp://guest:guest@localhost:5672/&quot; ) 
failOnError(err, &quot;Failed to connect to RabbitMQ&quot; )
defer conn.Close()
</code></pre>
<p><em>è¿æ¥æŠ½è±¡äº†å¥—æ¥å­—è¿æ¥ï¼Œå¹¶ä¸ºæˆ‘ä»¬å¤„ç†åè®®ç‰ˆæœ¬åå•†å’Œè®¤è¯ç­‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œè¿™æ˜¯å¤§å¤šæ•°ç”¨äºå®Œæˆä»»åŠ¡çš„ API æ‰€åœ¨çš„ä½ç½®ï¼š</em></p>
<pre><code class="language-go">ch, err := conn.Channel() 
failOnError(err, &quot;Failed to open a channel&quot; )
 defer ch.Close()
</code></pre>
<p><em>è¦å‘é€ï¼Œæˆ‘ä»¬å¿…é¡»å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ä¾›æˆ‘ä»¬å‘é€ï¼›ç„¶åæˆ‘ä»¬å¯ä»¥å‘é˜Ÿåˆ—å‘å¸ƒæ¶ˆæ¯ï¼š</em></p>
<pre><code class="language-go">q, err := ch.QueueDeclare(
  &quot;hello&quot;, // name
  false,   // durable
  false,   // delete when unused
  false,   // exclusive
  false,   // no-wait
  nil,     // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)

body := &quot;Hello World!&quot;
err = ch.Publish(
  &quot;&quot;,     // exchange
  q.Name, // routing key
  false,  // mandatory
  false,  // immediate
  amqp.Publishing {
    ContentType: &quot;text/plain&quot;,
    Body:        []byte(body),
  })
failOnError(err, &quot;Failed to publish a message&quot;)
</code></pre>
<p><em>å£°æ˜é˜Ÿåˆ—æ˜¯å¹‚ç­‰çš„ - åªæœ‰åœ¨å®ƒä¸å­˜åœ¨æ—¶æ‰ä¼šåˆ›å»ºå®ƒã€‚æ¶ˆæ¯å†…å®¹æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨å…¶ä¸­ç¼–ç ä»»ä½•æ‚¨å–œæ¬¢çš„å†…å®¹ã€‚</em></p>
<h5 id="sendgoå®Œæ•´ä»£ç ">send.goå®Œæ•´ä»£ç ï¼š</h5>
<pre><code class="language-go">package main

import (
	&quot;log&quot;
	amqp &quot;github.com/rabbitmq/amqp091-go&quot;
)

func failOnError(err error, msg string) {
	if err != nil {
		log.Fatalf(&quot;%s: %s&quot;, msg, err)
	}
}

func main() {
	conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
	failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
	defer conn.Close()

	ch, err := conn.Channel()
	failOnError(err, &quot;Failed to open a channel&quot;)
	defer ch.Close()

	q, err := ch.QueueDeclare(
		&quot;hello&quot;, // name
		false,   // durable
		false,   // delete when unused
		false,   // exclusive
		false,   // no-wait
		nil,     // arguments
	)
	failOnError(err, &quot;Failed to declare a queue&quot;)

	body := &quot;Hello World!&quot;
	err = ch.Publish(
		&quot;&quot;,     // exchange
		q.Name, // routing key
		false,  // mandatory
		false,  // immediate
		amqp.Publishing{
			ContentType: &quot;text/plain&quot;,
			Body:        []byte(body),
		})
	failOnError(err, &quot;Failed to publish a message&quot;)
	log.Printf(&quot; [x] Sent %s&quot;, body)
}
</code></pre>
<h4 id="æ¥æ”¶">æ¥æ”¶</h4>
<p><strong>æ¶ˆè´¹è€…</strong>ç›‘å¬æ¥è‡ª <strong>RabbitMQ</strong> çš„æ¶ˆæ¯ï¼Œå› æ­¤ä¸å‘å¸ƒå•ä¸ªæ¶ˆæ¯çš„å‘å¸ƒè€…ä¸åŒï¼Œæˆ‘ä»¬å°†ä¿æŒæ¶ˆè´¹è€…è¿è¡Œä»¥ç›‘å¬æ¶ˆæ¯å¹¶å°†å®ƒä»¬æ‰“å°å‡ºæ¥ã€‚</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/receiving.png" alt="receiving"></p>
<p>*è®¾ç½®ä¸å‘å¸ƒè€…ç›¸åŒ,æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªè¿æ¥å’Œä¸€ä¸ªé€šé“ï¼Œå¹¶å£°æ˜æˆ‘ä»¬è¦ä»ä¸­æ¶ˆè´¹çš„é˜Ÿåˆ—ã€‚*<em>è¯·æ³¨æ„ï¼Œè¿™ä¸å‘é€å‘å¸ƒçš„é˜Ÿåˆ—åŒ¹é…ã€‚</em></p>
<pre><code class="language-go">conn, err := amqp.Dial( &quot;amqp://guest:guest@localhost:5672/&quot; )
failOnError(err, &quot;æ— æ³•è¿æ¥åˆ° RabbitMQ&quot; )
defer conn.Close()

chï¼Œerrï¼š= conn.Channel()
failOnError(err, &quot;æ— æ³•æ‰“å¼€é¢‘é“&quot; )
è¿Ÿ ch.Close()

q, err := ch.QueueDeclare(
  &quot;hello&quot; , // åå­—
  false ,    // æŒä¹…
  false ,    // æœªä½¿ç”¨æ—¶åˆ é™¤
  false ,    // æ’ä»–æ€§
  false ,    // æ— éœ€ç­‰å¾…
  nil ,      // å‚æ•°
)
failOnError(err, &quot;æ— æ³•å£°æ˜é˜Ÿåˆ—&quot; )
</code></pre>
<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¹Ÿåœ¨è¿™é‡Œå£°æ˜äº†é˜Ÿåˆ—ã€‚å› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šåœ¨å‘å¸ƒè€…ä¹‹å‰å¯åŠ¨æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›åœ¨å°è¯•ä½¿ç”¨æ¥è‡ªé˜Ÿåˆ—çš„æ¶ˆæ¯ä¹‹å‰ç¡®ä¿é˜Ÿåˆ—å­˜åœ¨ã€‚</p>
<p>æˆ‘ä»¬å°†è¦å‘Šè¯‰æœåŠ¡å™¨å°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼ é€’ç»™æˆ‘ä»¬ã€‚ç”±äºå®ƒå°†å¼‚æ­¥æ¨é€æˆ‘ä»¬æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†ä»goroutine ä¸­çš„é€šé“ï¼ˆç”±amqp::Consumeè¿”å›ï¼‰è¯»å–æ¶ˆæ¯ã€‚</p>
<pre><code class="language-go">msgs, err := ch.Consume(
		q.Name, // queue
		&quot;&quot;,     // consumer
		true,   // auto-ack
		false,  // exclusive
		false,  // no-local
		false,  // no-wait
		nil,    // args
	)
	failOnError(err, &quot;Failed to register a consumer&quot;)

	forever := make(chan bool)

	go func() {
		for d := range msgs {
			log.Printf(&quot;Received a message: %s&quot;, d.Body)
		}
	}()

	log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
	&lt;-forever
</code></pre>
<h5 id="receiveå®Œæ•´ä»£ç ">receiveå®Œæ•´ä»£ç </h5>
<pre><code class="language-go">package main

import (
	&quot;log&quot;
	amqp &quot;github.com/rabbitmq/amqp091-go&quot;
)

func failOnError(err error, msg string) {
	if err != nil {
		log.Fatalf(&quot;%s: %s&quot;, msg, err)
	}
}

func main() {
	conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
	failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
	defer conn.Close()

	ch, err := conn.Channel()
	failOnError(err, &quot;Failed to open a channel&quot;)
	defer ch.Close()

	q, err := ch.QueueDeclare(
		&quot;hello&quot;, // name
		false,   // durable
		false,   // delete when unused
		false,   // exclusive
		false,   // no-wait
		nil,     // arguments
	)
	failOnError(err, &quot;Failed to declare a queue&quot;)

	msgs, err := ch.Consume(
		q.Name, // queue
		&quot;&quot;,     // consumer
		true,   // auto-ack
		false,  // exclusive
		false,  // no-local
		false,  // no-wait
		nil,    // args
	)
	failOnError(err, &quot;Failed to register a consumer&quot;)

	forever := make(chan bool)

	go func() {
		for d := range msgs {
			log.Printf(&quot;Received a message: %s&quot;, d.Body)
		}
	}()

	log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
	&lt;-forever
}
</code></pre>
<h5 id="ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™ä¸¤ä¸ªè„šæœ¬åœ¨ç»ˆç«¯ä¸­è¿è¡Œå‘å¸ƒè€…">ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™ä¸¤ä¸ªè„šæœ¬ã€‚åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œå‘å¸ƒè€…ï¼š</h5>
<pre><code class="language-sh">go run send.go
</code></pre>
<p>ç„¶åï¼Œè¿è¡Œæ¶ˆè´¹è€…ï¼š</p>
<pre><code class="language-sh">go run receive.go
</code></pre>
<p>æ¶ˆè´¹è€…å°†é€šè¿‡ RabbitMQ æ‰“å°å®ƒä»å‘å¸ƒè€…é‚£é‡Œå¾—åˆ°çš„æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…å°†ç»§ç»­è¿è¡Œï¼Œç­‰å¾…æ¶ˆæ¯ï¼Œå› æ­¤è¯·å°è¯•ä»å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå‘å¸ƒè€…ã€‚</p>
<h2 id="å·¥ä½œé˜Ÿåˆ—">å·¥ä½œé˜Ÿåˆ—</h2>
<p><img src="https://www.rabbitmq.com/img/tutorials/python-two.png" alt="python-two"></p>
<p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä»å‘½åé˜Ÿåˆ—å‘é€å’Œæ¥æ”¶æ¶ˆæ¯çš„ç¨‹åºã€‚åœ¨è¿™ä¸ªä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª<em>å·¥ä½œé˜Ÿåˆ—</em>ï¼Œç”¨äºåœ¨å¤šä¸ªå·¥ä½œäººå‘˜ä¹‹é—´åˆ†é…è€—æ—¶çš„ä»»åŠ¡ã€‚</p>
<p><em>å·¥ä½œé˜Ÿåˆ—</em>ï¼ˆåˆåï¼š<em>ä»»åŠ¡é˜Ÿåˆ—</em>ï¼‰èƒŒåçš„ä¸»è¦æ€æƒ³æ˜¯**é¿å…ç«‹å³æ‰§è¡Œèµ„æºå¯†é›†å‹ä»»åŠ¡è€Œä¸å¾—ä¸ç­‰å¾…å®ƒå®Œæˆã€‚**ç›¸åï¼Œæˆ‘ä»¬å®‰æ’ä»»åŠ¡ç¨åå®Œæˆã€‚æˆ‘ä»¬å°†<em>ä»»åŠ¡</em>å°è£… ä¸ºæ¶ˆæ¯å¹¶å°†å…¶å‘é€åˆ°é˜Ÿåˆ—ã€‚åœ¨åå°è¿è¡Œçš„å·¥ä½œè¿›ç¨‹å°†å¼¹å‡ºä»»åŠ¡å¹¶æœ€ç»ˆæ‰§è¡Œä½œä¸šã€‚å½“æ‚¨è¿è¡Œè®¸å¤šwarkeræ—¶ï¼Œä»»åŠ¡å°†åœ¨ä»–ä»¬ä¹‹é—´å…±äº«ã€‚</p>
<p>è¿™ä¸ªæ¦‚å¿µåœ¨ Web åº”ç”¨ç¨‹åºä¸­ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºåœ¨çŸ­çš„ HTTP è¯·æ±‚çª—å£æœŸé—´ä¸å¯èƒ½å¤„ç†å¤æ‚çš„ä»»åŠ¡ã€‚ï¼ˆå¼‚æ­¥)</p>
<h3 id="å‡†å¤‡">å‡†å¤‡</h3>
<p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­,æˆ‘ä»¬å‘é€äº†ä¸€ä¸ªåŒ…å«â€œHello World!â€çš„å­—ç¬¦ä¸²æ¶ˆæ¯ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†å‘é€ä¸€äº›å­—ç¬¦ä¸²ï¼ŒæŠŠè¿™äº›å­—ç¬¦ä¸²å½“ä½œå¤æ‚çš„ä»»åŠ¡ã€‚æˆ‘ä»¬æ²¡æœ‰çœŸå®çš„ä¾‹å­ï¼Œä¾‹å¦‚å›¾ç‰‡ç¼©æ”¾ã€pdfæ–‡ä»¶è½¬æ¢ã€‚æ‰€ä»¥ä½¿ç”¨time.sleep()å‡½æ•°æ¥æ¨¡æ‹Ÿè¿™ç§æƒ…å†µã€‚æˆ‘ä»¬åœ¨å­—ç¬¦ä¸²ä¸­åŠ ä¸Šç‚¹å·ï¼ˆ.ï¼‰æ¥è¡¨ç¤ºä»»åŠ¡çš„å¤æ‚ç¨‹åº¦ï¼Œä¸€ä¸ªç‚¹ï¼ˆ.ï¼‰å°†ä¼šè€—æ—¶1ç§’é’Ÿã€‚æ¯”å¦‚&quot;Hello&hellip;&ldquo;å°±ä¼šè€—æ—¶3ç§’é’Ÿã€‚</p>
<p><em>æˆ‘ä»¬å°†ç¨å¾®ä¿®æ”¹å‰é¢ç¤ºä¾‹ä¸­çš„<code>send.go</code>ä»£ç ï¼Œä»¥å…è®¸ä»å‘½ä»¤è¡Œå‘é€ä»»æ„æ¶ˆæ¯ã€‚è¯¥ç¨‹åºå°†å‘é€ä»»åŠ¡åˆ°æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶å‘½åä¸º<code>new_task.go</code>ï¼š</em></p>
<pre><code class="language-go">body := bodyFrom(os.Args)
err = ch.Publish(
  &quot;&quot;,           // exchange
  q.Name,       // routing key
  false,        // mandatory
  false,
  amqp.Publishing {
    DeliveryMode: amqp.Persistent,
    ContentType:  &quot;text/plain&quot;,
    Body:         []byte(body),
  })
failOnError(err, &quot;Failed to publish a message&quot;)
log.Printf(&quot; [x] Sent %s&quot;, body)
</code></pre>
<p><em><code>BodyFrom</code>å‡½æ•°ï¼š</em></p>
<pre><code class="language-go">func bodyFrom(args []string) string {
    var s string
    if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
        s = &quot;hello&quot;
    } else {
        s = strings.Join(args[1:], &quot; &quot;)
    }
    return s
}
</code></pre>
<p><em>æˆ‘ä»¬æ—§çš„<code>receive.go</code>ä¹Ÿéœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹ï¼šå®ƒéœ€è¦ä¸ºæ¶ˆæ¯ä½“ä¸­æ¯ä¸€ä¸ªç‚¹å·ï¼ˆ.ï¼‰æ¨¡æ‹Ÿ1ç§’é’Ÿçš„æ“ä½œã€‚å®ƒä¼šä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶æ‰§è¡Œï¼Œæˆ‘ä»¬æŠŠå®ƒå‘½åä¸º<code>worker.go</code>:</em></p>
<pre><code class="language-go">msgs, err := ch.Consume(
  q.Name, // queue
  &quot;&quot;,     // consumer
  true,   // auto-ack
  false,  // exclusive
  false,  // no-local
  false,  // no-wait
  nil,    // args
)
failOnError(err, &quot;Failed to register a consumer&quot;)

forever := make(chan bool)

go func() {
  for d := range msgs {
    log.Printf(&quot;Received a message: %s&quot;, d.Body)
    dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
    t := time.Duration(dot_count)
    time.Sleep(t * time.Second)
    log.Printf(&quot;Done&quot;)
  }
}()

log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
&lt;-forever
</code></pre>
<p><em>è¿è¡Œ:</em></p>
<pre><code class="language-shell"># shell 1
go run worker.go
# shell 2
go run new_task.go
</code></pre>
<p><em>æ•ˆæœï¼š</em></p>
<p><img src="/RabbitMQ/1.png" alt="output"></p>
<p><em>è§£é‡Šï¼šæ¶ˆæ¯ä¼šåŒæ­¥å‘é€ï¼Œå¦‚æœå‰ä¸€ä¸ªæ¶ˆæ¯è€—æ—¶é•¿ï¼Œåˆ™åä¸€ä¸ªæ¶ˆæ¯ä¼šè¢«é˜»å¡ç›¸åº”çš„æ—¶é—´</em></p>
<h3 id="å¾ªç¯è°ƒåº¦">å¾ªç¯è°ƒåº¦</h3>
<p>ä½¿ç”¨å·¥ä½œé˜Ÿåˆ—çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å®ƒèƒ½å¤Ÿå¹¶è¡Œåœ°å¤„ç†é˜Ÿåˆ—ã€‚å¦‚æœå †ç§¯äº†å¾ˆå¤šä»»åŠ¡ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ æ›´å¤šçš„å·¥ä½œè€…ï¼ˆworkersï¼‰å°±å¯ä»¥äº†ï¼Œæ‰©å±•å¾ˆç®€å•ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåŒæ—¶è¿è¡Œä¸¤ä¸ª<code>worker.go</code>ï¼Œå®ƒä»¬éƒ½ä¼šä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ã€‚</p>
<p><em>ä½ éœ€è¦æ‰“å¼€ä¸‰ä¸ªç»ˆç«¯ï¼Œä¸¤ä¸ªç”¨æ¥è¿è¡Œ<code>worker.go</code>ï¼Œè¿™ä¸¤ä¸ªç»ˆç«¯å°±æ˜¯æˆ‘ä»¬çš„ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ˆconsumersï¼‰â€”â€” C1 å’Œ C2ã€‚</em></p>
<pre><code class="language-shell"># shell 1
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C

# shell 2
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
</code></pre>
<p><em>ç¬¬ä¸‰ä¸ªç»ˆç«¯ï¼Œæˆ‘ä»¬ç”¨æ¥å‘å¸ƒæ–°ä»»åŠ¡ã€‚ä½ å¯ä»¥å‘é€ä¸€äº›æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰ï¼š</em></p>
<pre><code class="language-shell"># shell 3
go run new_task.go First message.
go run new_task.go Second message..
go run new_task.go Third message...
go run new_task.go Fourth message....
go run new_task.go Fifth message.....
</code></pre>
<p>çœ‹çœ‹åˆ°åº•å‘é€äº†ä»€ä¹ˆç»™æˆ‘ä»¬çš„å·¥ä½œè€…ï¼ˆworkersï¼‰ï¼š</p>
<pre><code class="language-go"># shell 1
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
# =&gt; [x] Received 'First message.'
# =&gt; [x] Received 'Third message...'
# =&gt; [x] Received 'Fifth message.....'


# shell 2
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
# =&gt; [x] Received 'Second message..'
# =&gt; [x] Received 'Fourth message....'
</code></pre>
<p>é»˜è®¤æ¥è¯´ï¼ŒRabbitMQä¼šæŒ‰é¡ºåºå¾—æŠŠæ¶ˆæ¯å‘é€ç»™æ¯ä¸ªæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰ã€‚å¹³å‡æ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°åŒç­‰æ•°é‡å¾—æ¶ˆæ¯ã€‚è¿™ç§å‘é€æ¶ˆæ¯å¾—æ–¹å¼å«åšâ€”â€”<em>è½®è¯¢</em>ï¼ˆround-robinï¼‰ã€‚è¯•ç€æ·»åŠ ä¸‰ä¸ªæˆ–æ›´å¤šå¾—å·¥ä½œè€…ï¼ˆworkersï¼‰ã€‚</p>
<h3 id="æ¶ˆæ¯ç¡®è®¤">æ¶ˆæ¯ç¡®è®¤</h3>
<p>å½“å¤„ç†ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶å¾—ä»»åŠ¡çš„æ—¶å€™ï¼Œä½ ä¹Ÿè®¸æƒ³çŸ¥é“æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰æ˜¯å¦è¿è¡Œåˆ°ä¸€åŠå°±æŒ‚æ‰ã€‚å½“å‰çš„ä»£ç ä¸­ï¼Œå½“æ¶ˆæ¯è¢«RabbitMQå‘é€ç»™æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰ä¹‹åï¼Œé©¬ä¸Šå°±ä¼šåœ¨å†…å­˜ä¸­ç§»é™¤ã€‚è¿™ç§æƒ…å†µï¼Œä½ åªè¦æŠŠä¸€ä¸ªå·¥ä½œè€…ï¼ˆworkerï¼‰åœæ­¢ï¼Œæ­£åœ¨å¤„ç†çš„æ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚åŒæ—¶ï¼Œæ‰€æœ‰å‘é€åˆ°è¿™ä¸ªå·¥ä½œè€…çš„è¿˜æ²¡æœ‰å¤„ç†çš„æ¶ˆæ¯éƒ½ä¼šä¸¢å¤±ã€‚</p>
<p>æˆ‘ä»¬ä¸æƒ³ä¸¢å¤±ä»»ä½•ä»»åŠ¡æ¶ˆæ¯ã€‚å¦‚æœä¸€ä¸ªå·¥ä½œè€…ï¼ˆworkerï¼‰æŒ‚æ‰äº†ï¼Œæˆ‘ä»¬å¸Œæœ›ä»»åŠ¡ä¼šé‡æ–°å‘é€ç»™å…¶ä»–çš„å·¥ä½œè€…ï¼ˆworkerï¼‰ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼ŒRabbitMQæä¾›äº†<strong>æ¶ˆæ¯å“åº”ï¼ˆacknowledgmentsï¼‰</strong>ã€‚æ¶ˆè´¹è€…ä¼šé€šè¿‡ä¸€ä¸ª<strong>ackï¼ˆå“åº”ï¼‰</strong>ï¼Œå‘Šè¯‰RabbitMQå·²ç»æ”¶åˆ°å¹¶å¤„ç†äº†æŸæ¡æ¶ˆæ¯ï¼Œç„¶åRabbitMQå°±ä¼šé‡Šæ”¾å¹¶åˆ é™¤è¿™æ¡æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰æŒ‚æ‰äº†ï¼Œæ²¡æœ‰å‘é€å“åº”ï¼ŒRabbitMQå°±ä¼šè®¤ä¸ºæ¶ˆæ¯æ²¡æœ‰è¢«å®Œå…¨å¤„ç†ï¼Œç„¶åé‡æ–°å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰ã€‚è¿™æ ·ï¼Œå³ä½¿å·¥ä½œè€…ï¼ˆworkersï¼‰å¶å°”çš„æŒ‚æ‰ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆæ¯æ˜¯æ²¡æœ‰è¶…æ—¶è¿™ä¸ªæ¦‚å¿µçš„ï¼›å½“å·¥ä½œè€…ä¸å®ƒæ–­å¼€è¿çš„æ—¶å€™ï¼ŒRabbitMQä¼šé‡æ–°å‘é€æ¶ˆæ¯ã€‚è¿™æ ·åœ¨å¤„ç†ä¸€ä¸ªè€—æ—¶éå¸¸é•¿çš„æ¶ˆæ¯ä»»åŠ¡çš„æ—¶å€™å°±ä¸ä¼šå‡ºé—®é¢˜äº†ã€‚</p>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ‰‹åŠ¨æ¶ˆæ¯ç¡®è®¤ï¼Œé€šè¿‡ä¸º<code>auto-ack</code>å‚æ•°ä¼ é€’falseï¼Œä¸€æ—¦æœ‰ä»»åŠ¡å®Œæˆï¼Œä½¿ç”¨<code>d.Ackï¼ˆfalseï¼‰</code>å‘RabbitMQæœåŠ¡å™¨å‘é€æ¶ˆè´¹å®Œæˆçš„ç¡®è®¤ï¼ˆè¿™ä¸ªç¡®è®¤æ¶ˆæ¯æ˜¯å•æ¬¡ä¼ é€’çš„ï¼‰ã€‚</p>
<pre><code class="language-go">//receive.go
msgs, err := ch.Consume(
  q.Name, // queue
  &quot;&quot;,     // consumer
  false,  // auto-ack
  false,  // exclusive
  false,  // no-local
  false,  // no-wait
  nil,    // args
)
failOnError(err, &quot;Failed to register a consumer&quot;)

forever := make(chan bool)

go func() {
  for d := range msgs {
    log.Printf(&quot;Received a message: %s&quot;, d.Body)
    dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
    t := time.Duration(dot_count)
    time.Sleep(t * time.Second)
    log.Printf(&quot;Done&quot;)
    d.Ack(false)
  }
}()

log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
&lt;-forever
</code></pre>
<h3 id="æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</h3>
<p>å¦‚æœä½ æ²¡æœ‰ç‰¹æ„å‘Šè¯‰RabbitMQï¼Œé‚£ä¹ˆåœ¨å®ƒé€€å‡ºæˆ–è€…å´©æºƒçš„æ—¶å€™ï¼Œå°†ä¼šä¸¢å¤±æ‰€æœ‰é˜Ÿåˆ—å’Œæ¶ˆæ¯ã€‚ä¸ºäº†ç¡®ä¿ä¿¡æ¯ä¸ä¼šä¸¢å¤±ï¼Œæœ‰ä¸¤ä¸ªäº‹æƒ…æ˜¯éœ€è¦æ³¨æ„çš„ï¼šæˆ‘ä»¬å¿…é¡»æŠŠâ€œé˜Ÿåˆ—â€å’Œâ€œæ¶ˆæ¯â€è®¾ä¸ºæŒä¹…åŒ–ã€‚</p>
<p>é¦–å…ˆï¼Œä¸ºäº†ä¸è®©é˜Ÿåˆ—æ¶ˆå¤±ï¼Œéœ€è¦æŠŠé˜Ÿåˆ—å£°æ˜ä¸ºæŒä¹…åŒ–ï¼ˆdurableï¼‰ï¼š</p>
<pre><code class="language-go">q, err := ch.QueueDeclare(
  &quot;hello&quot;,      // name
  true,         // durable
  false,        // delete when unused
  false,        // exclusive
  false,        // no-wait
  nil,          // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)
</code></pre>
<p>å°½ç®¡è¿™è¡Œä»£ç æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è¾¾ä¸åˆ°æˆ‘ä»¬é¢„æœŸçš„ç»“æœã€‚å› ä¸ºæˆ‘ä»¬å·²ç»å®šä¹‰è¿‡ä¸€ä¸ªå«<code>hello</code>çš„éæŒä¹…åŒ–é˜Ÿåˆ—ã€‚RabbitMqä¸å…è®¸ä½ ä½¿ç”¨ä¸åŒçš„å‚æ•°é‡æ–°å®šä¹‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ä½†æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ä¸€ä¸ªå¿«æ·çš„è§£å†³æ–¹æ³•â€”â€”ç”¨ä¸åŒçš„åå­—ï¼Œä¾‹å¦‚<code>task_queue</code>ã€‚</p>
<pre><code class="language-go">q, err := ch.QueueDeclare(
  &quot;task_queue&quot;, // name
  true,         // durable
  false,        // delete when unused
  false,        // exclusive
  false,        // no-wait
  nil,          // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)
</code></pre>
<p>è¿™ä¸ª<code>durable</code>å¿…é¡»åœ¨ç”Ÿäº§è€…ï¼ˆproducerï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰å¯¹åº”çš„ä»£ç ä¸­ä¿®æ”¹ã€‚</p>
<p>æ­¤æ—¶ï¼Œå·²ç»ç¡®ä¿å³ä½¿RabbitMQé‡æ–°å¯åŠ¨ï¼Œ<code>task_queue</code>é˜Ÿåˆ—ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…æ€§ - é€šè¿‡è®¾ç½®<code>amqp.Publishing</code>çš„<code>amqp.Persistent</code>å±æ€§å®Œæˆã€‚</p>
<pre><code class="language-go">err = ch.Publish(
  &quot;&quot;,           // exchange
  q.Name,       // routing key
  false,        // mandatory
  false,
  amqp.Publishing {
    DeliveryMode: amqp.Persistent,
    ContentType:  &quot;text/plain&quot;,
    Body:         []byte(body),
})
</code></pre>
<blockquote>
<h5 id="æ³¨æ„æ¶ˆæ¯æŒä¹…åŒ–">æ³¨æ„ï¼šæ¶ˆæ¯æŒä¹…åŒ–</h5>
<p>å°†æ¶ˆæ¯è®¾ä¸ºæŒä¹…åŒ–å¹¶ä¸èƒ½å®Œå…¨ä¿è¯ä¸ä¼šä¸¢å¤±ã€‚ä»¥ä¸Šä»£ç åªæ˜¯å‘Šè¯‰äº†RabbitMqè¦æŠŠæ¶ˆæ¯å­˜åˆ°ç¡¬ç›˜ï¼Œä½†ä»RabbitMqæ”¶åˆ°æ¶ˆæ¯åˆ°ä¿å­˜ä¹‹é—´è¿˜æ˜¯æœ‰ä¸€ä¸ªå¾ˆå°çš„é—´éš”æ—¶é—´ã€‚å› ä¸ºRabbitMqå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä½¿ç”¨fsync(2)â€”â€”å®ƒæœ‰å¯èƒ½åªæ˜¯ä¿å­˜åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ä¸€å®šä¼šå†™åˆ°ç¡¬ç›˜ä¸­ã€‚å¹¶ä¸èƒ½ä¿è¯çœŸæ­£çš„æŒä¹…åŒ–ï¼Œä½†å·²ç»è¶³å¤Ÿåº”ä»˜æˆ‘ä»¬çš„ç®€å•å·¥ä½œé˜Ÿåˆ—ã€‚å¦‚æœæ‚¨éœ€è¦æ›´å¼ºçš„ä¿è¯ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨<a href="https://www.rabbitmq.com/confirms.html">publisher confirms.</a>ã€‚</p>
</blockquote>
<h3 id="å…¬å¹³è°ƒåº¦">å…¬å¹³è°ƒåº¦</h3>
<p>ä½ åº”è¯¥å·²ç»å‘ç°ï¼Œå®ƒä»æ—§æ²¡æœ‰æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„é‚£æ ·è¿›è¡Œåˆ†å‘ã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªå·¥ä½œè€…ï¼ˆworkersï¼‰ï¼Œå¤„ç†å¥‡æ•°æ¶ˆæ¯çš„æ¯”è¾ƒç¹å¿™ï¼Œå¤„ç†å¶æ•°æ¶ˆæ¯çš„æ¯”è¾ƒè½»æ¾ã€‚ç„¶è€ŒRabbitMQå¹¶ä¸çŸ¥é“è¿™äº›ï¼Œå®ƒä»ç„¶ä¸€å¦‚æ—¢å¾€çš„æ´¾å‘æ¶ˆæ¯ã€‚</p>
<p>è¿™æ—¶å› ä¸ºRabbitMQåªç®¡åˆ†å‘è¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œä¸ä¼šå…³å¿ƒæœ‰å¤šå°‘æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰æ²¡æœ‰ä½œå‡ºå“åº”ã€‚å®ƒç›²ç›®çš„æŠŠç¬¬n-thæ¡æ¶ˆæ¯å‘ç»™ç¬¬n-thä¸ªæ¶ˆè´¹è€…ã€‚</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/prefetch-count.png" alt="prefetch-count"></p>
<p>æˆ‘ä»¬å¯ä»¥è®¾ç½®é¢„å–è®¡æ•°å€¼ä¸º1ã€‚å‘Šè¯‰RabbitMQä¸€æ¬¡åªå‘ä¸€ä¸ªworkerå‘é€ä¸€æ¡æ¶ˆæ¯ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨å¤„ç†å¹¶ç¡®è®¤å‰ä¸€ä¸ªæ¶ˆæ¯ä¹‹å‰ï¼Œä¸è¦å‘å·¥ä½œäººå‘˜å‘é€æ–°æ¶ˆæ¯ã€‚</p>
<pre><code class="language-go">err = ch.Qos(
  1,     // prefetch count
  0,     // prefetch size
  false, // global
)
failOnError(err, &quot;Failed to set QoS&quot;)
</code></pre>
<blockquote>
<h5 id="å…³äºé˜Ÿåˆ—å¤§å°">å…³äºé˜Ÿåˆ—å¤§å°</h5>
<p>å¦‚æœæ‰€æœ‰çš„å·¥ä½œè€…éƒ½å¤„ç†ç¹å¿™çŠ¶æ€ï¼Œä½ çš„é˜Ÿåˆ—å°±ä¼šè¢«å¡«æ»¡ã€‚ä½ éœ€è¦ç•™æ„è¿™ä¸ªé—®é¢˜ï¼Œè¦ä¹ˆæ·»åŠ æ›´å¤šçš„å·¥ä½œè€…ï¼ˆworkersï¼‰ï¼Œè¦ä¹ˆä½¿ç”¨å…¶ä»–ç­–ç•¥ã€‚</p>
</blockquote>
<h4 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h4>
<h5 id="sendgoä»£ç ">send.goä»£ç ï¼š</h5>
<pre><code class="language-go">package main

import (
        &quot;log&quot;
        &quot;os&quot;
        &quot;strings&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        q, err := ch.QueueDeclare(
                &quot;task_queue&quot;, // name
                true,         // durable
                false,        // delete when unused
                false,        // exclusive
                false,        // no-wait
                nil,          // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        body := bodyFrom(os.Args)
        err = ch.Publish(
                &quot;&quot;,           // exchange
                q.Name,       // routing key
                false,        // mandatory
                false,
                amqp.Publishing{
                        DeliveryMode: amqp.Persistent,
                        ContentType:  &quot;text/plain&quot;,
                        Body:         []byte(body),
                })
        failOnError(err, &quot;Failed to publish a message&quot;)
        log.Printf(&quot; [x] Sent %s&quot;, body)
}

func bodyFrom(args []string) string {
        var s string
        if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
                s = &quot;hello&quot;
        } else {
                s = strings.Join(args[1:], &quot; &quot;)
        }
        return s
}
</code></pre>
<h5 id="receivegoä»£ç ">receive.goä»£ç :</h5>
<pre><code class="language-go">package main

import (
        &quot;bytes&quot;
        &quot;github.com/streadway/amqp&quot;
        &quot;log&quot;
        &quot;time&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        q, err := ch.QueueDeclare(
                &quot;task_queue&quot;, // name
                true,         // durable
                false,        // delete when unused
                false,        // exclusive
                false,        // no-wait
                nil,          // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        err = ch.Qos(
                1,     // prefetch count
                0,     // prefetch size
                false, // global
        )
        failOnError(err, &quot;Failed to set QoS&quot;)

        msgs, err := ch.Consume(
                q.Name, // queue
                &quot;&quot;,     // consumer
                false,  // auto-ack
                false,  // exclusive
                false,  // no-local
                false,  // no-wait
                nil,    // args
        )
        failOnError(err, &quot;Failed to register a consumer&quot;)

        forever := make(chan bool)

        go func() {
                for d := range msgs {
                        log.Printf(&quot;Received a message: %s&quot;, d.Body)
                        dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
                        t := time.Duration(dot_count)
                        time.Sleep(t * time.Second)
                        log.Printf(&quot;Done&quot;)
                        d.Ack(false)
                }
        }()

        log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
        &lt;-forever
}
</code></pre>

        </div>
        
        <div class="my-4">
    
    <a href="https://damon-zhangb.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#æ¶ˆæ¯é˜Ÿåˆ—</a>
    
    <a href="https://damon-zhangb.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#åˆ†å¸ƒå¼</a>
    
</div>
        
        
        


        
        
        <div class="py-2">
    
    <div class="flex flex-col md:flex-row items-center my-8">
        <a href="https://damon-zhangb.github.io/authors/me/" class="w-24 h-24 md:mr-4">
            
            
            <img src="https://damon-zhangb.github.io/android-chrome-512x512.png" class="w-full bg-primary-bg rounded-full" alt="Avatar">
            
        </a>
        <div class="w-full md:w-auto mt-4 md:mt-0">
            <a href="https://damon-zhangb.github.io/authors/me/" class="block font-bold text-lg pb-1 mb-2 border-b">Zhang Bu</a>
            <span class="block pb-2">Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos.</span>
            
            
            
            
            
            <a href="mailto:example@example.com" class="mr-1">
                <i class="fab fa-fab fa-weixin"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-fab fa-qq"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-github"></i>
            </a>
            
            
            
            
            
            <a href="https://example.com/" class="mr-1">
                <i class="fab fa-fab fa-zhihu"></i>
            </a>
            
        </div>
    </div>
    
</div>
        
        
        
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
    <div>
        
    </div>
    <div class="md:text-right mt-4 md:mt-0">
        
        <span class="block font-bold">ä¸‹ä¸€é¡µ</span>
        <a href="https://damon-zhangb.github.io/posts/go-%E6%AF%8F%E6%97%A5%E4%B8%80%E5%BA%93%E4%B9%8B-cron/" class="block">Go æ¯æ—¥ä¸€åº“ä¹‹ cron</a>
        
    </div>
</div>

        



    </div>
    
    <div class="col-span-2">
        
        
<div class="bg-secondary-bg rounded p-6">
    <h3 class="text-lg font-semibold mb-4">ç³»åˆ—æ–‡ç« </h3>
    <div class="content">
        
        
        <a href="https://damon-zhangb.github.io/posts/rabbitmq/">RabbitMQï¼ˆ1ï¼‰</a>
        <br />
        
        
    </div>
</div>
        
        
        <div class="sticky top-16 z-10 hidden lg:block px-6 py-4  bg-primary-bg ">
    <span class="text-lg font-semibold">æœ¬é¡µå†…å®¹</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6 ">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#hello-world">hello world</a>
      <ul>
        <li><a href="#ä»‹ç»">ä»‹ç»</a></li>
        <li><a href="#hello-world-1">Hello World</a>
          <ul>
            <li>
              <ul>
                <li><a href="#go-rabbitmq-å®¢æˆ·ç«¯åº“">Go RabbitMQ å®¢æˆ·ç«¯åº“</a></li>
              </ul>
            </li>
            <li><a href="#å‘é€">å‘é€</a>
              <ul>
                <li><a href="#sendgoå®Œæ•´ä»£ç ">send.goå®Œæ•´ä»£ç ï¼š</a></li>
              </ul>
            </li>
            <li><a href="#æ¥æ”¶">æ¥æ”¶</a>
              <ul>
                <li><a href="#receiveå®Œæ•´ä»£ç ">receiveå®Œæ•´ä»£ç </a></li>
                <li><a href="#ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™ä¸¤ä¸ªè„šæœ¬åœ¨ç»ˆç«¯ä¸­è¿è¡Œå‘å¸ƒè€…">ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™ä¸¤ä¸ªè„šæœ¬ã€‚åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œå‘å¸ƒè€…ï¼š</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#å·¥ä½œé˜Ÿåˆ—">å·¥ä½œé˜Ÿåˆ—</a>
      <ul>
        <li><a href="#å‡†å¤‡">å‡†å¤‡</a></li>
        <li><a href="#å¾ªç¯è°ƒåº¦">å¾ªç¯è°ƒåº¦</a></li>
        <li><a href="#æ¶ˆæ¯ç¡®è®¤">æ¶ˆæ¯ç¡®è®¤</a></li>
        <li><a href="#æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</a>
          <ul>
            <li>
              <ul>
                <li><a href="#æ³¨æ„æ¶ˆæ¯æŒä¹…åŒ–">æ³¨æ„ï¼šæ¶ˆæ¯æŒä¹…åŒ–</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#å…¬å¹³è°ƒåº¦">å…¬å¹³è°ƒåº¦</a>
          <ul>
            <li>
              <ul>
                <li><a href="#å…³äºé˜Ÿåˆ—å¤§å°">å…³äºé˜Ÿåˆ—å¤§å°</a></li>
              </ul>
            </li>
            <li><a href="#å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </a>
              <ul>
                <li><a href="#sendgoä»£ç ">send.goä»£ç ï¼š</a></li>
                <li><a href="#receivegoä»£ç ">receive.goä»£ç :</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
</div>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        enableStickyToc();
    });
</script>
        
    </div>
    

    
    
    <div
        class="col-span-2  lg:col-span-6 bg-secondary-bg rounded p-6">
        <h2 class="text-lg font-semibold mb-4">ç›¸å…³</h2>
        <div class="content">
            
            <a href="https://damon-zhangb.github.io/posts/rpc-protobuf/">RPC --ProtoBuf</a>
            <br />
            
            <a href="https://damon-zhangb.github.io/posts/rpc-grpc/">RPC --gRPC</a>
            <br />
            
            <a href="https://damon-zhangb.github.io/posts/rpc-%E5%85%A5%E9%97%A8/">RPC --å…¥é—¨</a>
            <br />
            
        </div>
    </div>
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        hljs.initHighlightingOnLoad();
    })
</script>

      </div>
    </div>
    
  </main>
  <footer class="pl-scrollbar">
    <div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
    <p class="text-sm text-tertiary-text">&copy; 2021 <a href="https://github.com/Damon-Zhangb">Damon.Zhang</a>
 &middot;  Powered by the <a href="https://github.com/wangchucheng/hugo-eureka" class="hover:text-eureka">Eureka</a> theme for <a href="https://gohugo.io" class="hover:text-eureka">Hugo</a></p>
</div></div>
  </footer>
</body>

</html>